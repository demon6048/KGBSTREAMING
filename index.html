<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KGB STREAMING v14.0 | Fix</title>
    <!-- LIBRERÃAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f1f5f9; }
        .nav-item.active { background-color: #4338ca; color: white; border-left: 4px solid #a5b4fc; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); }
        .refunded-row { background-color: #fee2e2 !important; color: #991b1b !important; text-decoration: line-through; opacity: 0.7; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        #mobile-overlay { transition: opacity 0.3s ease-in-out; }
        #sync-indicator { transition: opacity 0.5s; pointer-events: none; opacity: 0; }
        #sync-indicator.active { opacity: 1; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-slate-800 bg-slate-50">

    <!-- NotificaciÃ³n Flotante -->
    <div id="sync-indicator" class="fixed top-4 right-4 z-[100] bg-white text-indigo-800 text-xs px-4 py-2 rounded-full shadow-xl border border-indigo-100 flex items-center gap-2 font-bold transform translate-y-0">
        <i class="fa-solid fa-cloud-arrow-up animate-bounce"></i> Guardando...
    </div>

    <!-- Overlay MÃ³vil -->
    <div id="mobile-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/60 z-40 hidden md:hidden backdrop-blur-sm"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 text-slate-300 flex flex-col z-50 shadow-2xl border-r border-slate-800 transform -translate-x-full md:translate-x-0 h-full transition-transform duration-300">
        <div class="flex justify-between items-center p-4 md:hidden border-b border-slate-800 bg-slate-950">
            <span class="font-bold text-white text-xs uppercase tracking-widest">MenÃº</span>
            <button onclick="toggleMobileMenu()" class="text-white hover:text-red-400 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div class="h-28 flex items-center justify-center border-b border-slate-800 p-4 bg-slate-950 hidden md:flex relative group">
            <div class="text-center">
                <div class="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center text-white text-2xl shadow-lg mx-auto mb-2"><i class="fa-solid fa-table"></i></div>
                <h1 class="text-sm font-black text-white tracking-widest">KGB SHEETS</h1>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto px-4 py-6 space-y-3">
            <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 px-2">Operaciones</div>
            <div onclick="UI.switchTab('pos')" id="btn-nav-pos" class="nav-item active cursor-pointer w-full flex items-center px-4 py-3.5 rounded-xl hover:bg-slate-800 transition active bg-indigo-700 text-white font-bold shadow-lg"><i class="fa-solid fa-cart-shopping w-5 mr-3"></i> <span>Venta Nueva</span></div>
            <div onclick="UI.switchTab('history')" id="btn-nav-history" class="nav-item cursor-pointer w-full flex items-center px-4 py-3.5 rounded-xl hover:bg-slate-800 transition"><i class="fa-solid fa-list-check w-5 mr-3"></i> <span>Historial</span></div>
            <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 px-2 mt-6">GestiÃ³n</div>
            <div onclick="UI.switchTab('dashboard')" id="btn-nav-dashboard" class="nav-item cursor-pointer w-full flex items-center px-4 py-3.5 rounded-xl hover:bg-slate-800 transition"><i class="fa-solid fa-chart-pie w-5 mr-3"></i> <span>Reportes</span></div>
            <div onclick="UI.switchTab('config')" id="btn-nav-config" class="nav-item cursor-pointer w-full flex items-center px-4 py-3.5 rounded-xl hover:bg-slate-800 transition"><i class="fa-solid fa-sliders w-5 mr-3"></i> <span>ConfiguraciÃ³n</span></div>
        </div>
        <div class="p-5 bg-black/20 border-t border-slate-800 text-center text-xs">
            <div class="flex items-center justify-center gap-2 mb-1"><div id="status-dot" class="w-2.5 h-2.5 rounded-full bg-orange-500"></div><span id="status-text" class="font-bold text-slate-300">Conectando...</span></div>
            <p class="text-indigo-500 font-bold">JosÃ© Vizcarra</p>
        </div>
    </aside>

    <!-- HEADER -->
    <header class="bg-white h-16 border-b border-gray-200 flex items-center justify-between px-4 md:ml-64 z-30 fixed top-0 right-0 left-0 transition-all">
        <div class="flex items-center gap-4">
            <button onclick="toggleMobileMenu()" class="md:hidden text-slate-700 p-2 rounded-lg hover:bg-slate-100 transition focus:outline-none"><i class="fa-solid fa-bars text-xl"></i></button>
            <div><h1 class="text-lg md:text-xl font-black text-slate-900 tracking-tight leading-none">KGB <span class="text-indigo-600">STREAMING</span></h1><p class="text-[9px] text-slate-400 font-bold hidden sm:block">Control v14.0</p></div>
        </div>
        <button onclick="DATA.forceSync()" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-100 hover:bg-indigo-100 transition flex items-center gap-2"><i class="fa-solid fa-rotate"></i> <span class="hidden sm:inline">Sincronizar</span></button>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 bg-slate-50 overflow-y-auto p-4 md:p-8 pt-20 md:ml-64 h-full">
        <div class="max-w-6xl mx-auto pb-20">
            <!-- 1. POS -->
            <div id="view-pos" class="view-section w-full max-w-3xl mx-auto">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-5 border-b border-gray-100 flex justify-between items-center"><h2 class="text-base md:text-lg font-black text-slate-800 flex gap-2"><i class="fa-solid fa-cash-register text-indigo-600"></i> REGISTRAR</h2><span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded font-bold">ID: <span id="pos-id">#--</span></span></div>
                    <div class="p-6 md:p-8 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Vendedor</label><select id="pos-seller" class="w-full border p-3 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 bg-white transition"></select></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Plataforma</label><select id="pos-product" onchange="UI.updatePosCalc()" class="w-full border p-3 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 bg-white transition"></select></div>
                        </div>
                        <div class="bg-slate-900 text-white rounded-2xl p-6 shadow-lg relative overflow-hidden">
                            <div class="grid grid-cols-3 gap-2 text-center relative z-10">
                                <div><p class="text-[9px] text-slate-400 font-bold uppercase mb-1">COSTO</p><input id="pos-cost" readonly class="w-full bg-transparent text-center font-mono text-lg font-bold text-slate-400 outline-none" value="0.00"></div>
                                <div class="border-x border-slate-700"><p class="text-[9px] text-indigo-400 font-bold uppercase mb-1">VENTA</p><input id="pos-price" type="number" oninput="UI.reCalcProfitOnly()" class="w-full bg-transparent text-center font-mono text-2xl font-bold text-white outline-none focus:text-indigo-400 transition" value="0.00"></div>
                                <div><p class="text-[9px] text-emerald-400 font-bold uppercase mb-1">GANANCIA</p><p id="pos-profit" class="font-mono text-xl font-bold text-emerald-400 mt-1">0.00</p></div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-700 flex justify-center gap-6 text-[10px] uppercase font-bold text-slate-400 relative z-10">
                                <span>Admin (<span id="lbl-admin">60%</span>): <span id="view-admin" class="text-indigo-400">0.00</span></span>
                                <span>Vend (<span id="lbl-seller">40%</span>): <span id="view-seller" class="text-emerald-400">0.00</span></span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="pos-client" placeholder="Nombre Cliente" class="border p-3 rounded-xl text-sm w-full outline-none focus:border-indigo-500 transition"><input type="tel" id="pos-phone" placeholder="TelÃ©fono Cliente" class="border p-3 rounded-xl text-sm w-full outline-none focus:border-indigo-500 transition"></div>
                        <button onclick="DATA.submitSale()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transition text-sm uppercase tracking-widest active:scale-[0.98]">Confirmar Venta</button>
                    </div>
                </div>
            </div>

            <!-- 2. HISTORY, 3. CONFIG, 4. DASHBOARD (Misma estructura optimizada) -->
            <!-- ... (Se mantienen igual, simplificado para no alargar) ... -->
             <div id="view-history" class="view-section hidden w-full">
                <h2 class="text-xl font-black text-slate-800 mb-4 flex gap-2 items-center"><i class="fa-solid fa-list-check text-indigo-500"></i> Historial</h2>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200 mb-6"><div class="grid grid-cols-2 md:grid-cols-4 gap-3 items-end"><div class="col-span-1"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Desde</label><input type="date" id="filter-start" onchange="UI.renderHistoryTable()" class="w-full border rounded-lg p-2 text-xs outline-none focus:border-indigo-500"></div><div class="col-span-1"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Hasta</label><input type="date" id="filter-end" onchange="UI.renderHistoryTable()" class="w-full border rounded-lg p-2 text-xs outline-none focus:border-indigo-500"></div><div class="col-span-2 md:col-span-1"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Vendedor</label><select id="filter-seller" onchange="UI.renderHistoryTable()" class="w-full border rounded-lg p-2 text-xs outline-none focus:border-indigo-500"></select></div><button onclick="UI.exportToExcel()" class="col-span-2 md:col-span-1 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-bold shadow flex justify-center items-center gap-2 text-xs h-[34px] transition"><i class="fa-solid fa-file-excel"></i> Exportar</button></div></div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border overflow-hidden flex flex-col h-[500px]"><div class="overflow-x-auto flex-1"><table class="w-full text-sm text-left whitespace-nowrap"><thead class="bg-slate-50 text-xs text-slate-500 uppercase sticky top-0 z-10 font-bold"><tr><th class="p-4">Detalle</th><th class="p-4">Cliente</th><th class="p-4 text-right">ComisiÃ³n</th><th class="p-4 text-center">AcciÃ³n</th></tr></thead><tbody id="history-body" class="divide-y divide-gray-100"></tbody></table></div></div><div class="lg:col-span-1 bg-slate-900 text-white p-6 rounded-3xl shadow-xl sticky top-0 h-fit"><h3 class="font-bold text-base mb-4 flex gap-2"><i class="fa-solid fa-wallet text-indigo-400"></i> Caja Real</h3><div class="space-y-3 mb-6 border-b border-slate-700 pb-4"><div class="flex justify-between"><span class="text-slate-400 text-xs">Ventas</span><span class="font-mono font-bold" id="liq-total">0.00</span></div><div class="flex justify-between"><span class="text-slate-400 text-xs">Ops</span><span class="font-mono font-bold" id="liq-count">0</span></div><div class="flex justify-between text-red-400"><span class="text-xs">Reembolsos</span><span class="font-mono font-bold" id="liq-refunds">0</span></div></div><div class="bg-indigo-600 p-4 rounded-xl text-center"><p class="text-[10px] font-bold uppercase mb-1 text-indigo-200">A PAGAR</p><p class="text-3xl font-black font-mono" id="liq-comm">0.00</p></div></div></div>
            </div>
            
            <div id="view-config" class="view-section hidden w-full pb-20">
                <h2 class="text-xl font-black text-slate-800 mb-6">CONFIGURACIÃ“N</h2>
                <div class="flex flex-col gap-6">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200"><h3 class="font-bold text-slate-700 mb-4 text-xs uppercase tracking-widest border-b pb-2">Plataformas</h3><div class="bg-indigo-50 p-4 rounded-xl mb-4 border border-indigo-100 flex flex-col md:flex-row gap-2"><input type="hidden" id="edit-prod-id"><input type="text" id="new-prod-name" placeholder="Nombre" class="flex-grow border rounded-lg px-3 py-2 text-sm"><div class="flex gap-2"><input type="number" id="new-prod-cost" placeholder="Costo" class="w-20 border rounded-lg px-2 py-2 text-sm text-center"><input type="number" id="new-prod-price" placeholder="Venta" class="w-20 border rounded-lg px-2 py-2 text-sm text-center"><button id="btn-prod-action" onclick="DATA.addProd()" class="bg-indigo-600 text-white px-4 rounded-lg font-bold text-sm shadow-md transition">Agregar</button><button id="btn-prod-cancel" onclick="UI.cancelEdit('prod')" class="bg-slate-300 text-slate-600 px-3 rounded-lg font-bold text-sm hidden hover:bg-slate-400"><i class="fa-solid fa-xmark"></i></button></div></div><div class="overflow-y-auto max-h-60 border rounded-xl"><table class="w-full text-sm text-left"><tbody id="config-prod-list" class="divide-y divide-gray-100 text-slate-700"></tbody></table></div></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200"><h3 class="font-bold text-slate-700 mb-4 text-xs uppercase tracking-widest border-b pb-2">Vendedores</h3><div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-100 flex flex-col md:flex-row gap-2"><input type="hidden" id="edit-seller-id"><input type="text" id="new-seller-name" placeholder="Nombre" class="flex-grow border rounded-lg px-3 py-2 text-sm"><div class="flex gap-2"><input type="tel" id="new-seller-phone" placeholder="Celular" class="w-32 border rounded-lg px-3 py-2 text-sm"><button id="btn-seller-action" onclick="DATA.addSeller()" class="bg-slate-800 text-white px-4 rounded-lg font-bold text-sm shadow-md transition">Crear</button><button id="btn-seller-cancel" onclick="UI.cancelEdit('seller')" class="bg-slate-300 text-slate-600 px-3 rounded-lg font-bold text-sm hidden hover:bg-slate-400"><i class="fa-solid fa-xmark"></i></button></div></div><div class="overflow-y-auto max-h-60"><ul id="config-seller-list" class="space-y-2"></ul></div></div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200"><h3 class="font-bold text-slate-700 mb-4 text-xs uppercase tracking-widest border-b pb-2">3. DistribuciÃ³n</h3><div class="space-y-4"><div><label class="flex justify-between text-xs font-bold text-slate-500 mb-1">Admin: <span id="display-admin-pct" class="text-indigo-600">60%</span></label><input type="range" id="range-admin" min="0" max="100" value="60" oninput="UI.updateConfigRange('admin')" class="w-full h-1.5 bg-slate-200 rounded-lg accent-indigo-600"></div><div><label class="flex justify-between text-xs font-bold text-slate-500 mb-1">Vendedor: <span id="display-seller-pct" class="text-emerald-600">40%</span></label><input type="range" id="range-seller" min="0" max="100" value="40" oninput="UI.updateConfigRange('seller')" class="w-full h-1.5 bg-slate-200 rounded-lg accent-emerald-500"></div><button onclick="DATA.saveConfig()" class="w-full py-2 bg-slate-900 text-white rounded-lg text-xs font-bold uppercase tracking-widest hover:bg-black transition shadow-lg">Guardar Cambios</button></div></div>
                </div>
            </div>

            <div id="view-dashboard" class="view-section hidden w-full"><h2 class="text-xl font-black text-slate-800 mb-6">REPORTES</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6"><div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase">Ventas</p><p id="dash-total" class="text-xl font-black text-slate-800">0.00</p></div><div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-indigo-500 font-bold uppercase">Utilidad</p><p id="dash-admin" class="text-xl font-black text-indigo-600">0.00</p></div><div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-emerald-500 font-bold uppercase">Comisiones</p><p id="dash-seller" class="text-xl font-black text-emerald-600">0.00</p></div><div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase">Ops</p><p id="dash-count" class="text-xl font-black text-slate-800">0</p></div></div><div class="bg-white p-4 rounded-2xl border shadow-sm h-64 md:h-96 w-full"><canvas id="chartSellers"></canvas></div></div>

        </div>
    </main>

    <div id="toast" class="fixed bottom-8 right-1/2 translate-x-1/2 md:translate-x-0 md:right-8 bg-slate-900 text-white px-5 py-3 rounded-xl shadow-2xl translate-y-40 transition-transform duration-500 z-50 flex items-center gap-3 whitespace-nowrap"><div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white"><i class="fa-solid fa-check text-xs"></i></div><p class="text-xs md:text-sm font-bold">Â¡Hecho!</p></div>

    <script>
        // ==========================================
        //  TU URL DE GOOGLE APPS SCRIPT
        //  REEMPLAZA AQUÃ SI LA CAMBIAS
        // ==========================================
        const API_URL = "https://script.google.com/macros/s/AKfycbyRxtBowlGzcSuJyVSwAS1IVczW6uqqtQ86gHRHtt_6ivytiYOPkrPnecC6bGEPGYot4w/exec";
        // ==========================================

        const DEFAULT_DB = { sellers: [], products: [], sales: [], config: { adminPct: 0.60, sellerPct: 0.40 } };
        let DB = JSON.parse(localStorage.getItem('kgb_v14_db')) || DEFAULT_DB;

        // UI HELPERS
        function toggleMobileMenu() { const sb=document.getElementById('sidebar'), ov=document.getElementById('mobile-overlay'); if(sb.classList.contains('-translate-x-full')){sb.classList.remove('-translate-x-full');ov.classList.remove('hidden');}else{sb.classList.add('-translate-x-full');ov.classList.add('hidden');} }
        function showToast(m) { const t=document.getElementById('toast');t.querySelector('p').innerText=m;t.classList.remove('translate-y-40');setTimeout(()=>t.classList.add('translate-y-40'),2500); }
        function showSync(v) { const el=document.getElementById('sync-indicator'); if(v) el.classList.add('active'); else el.classList.remove('active'); }
        function updateStatus(online) {
            const dot = document.getElementById('status-dot'); const txt = document.getElementById('status-text');
            if(online){ dot.classList.replace('bg-orange-500','bg-green-500'); dot.classList.add('animate-pulse'); txt.innerText="Nube OK"; txt.classList.add('text-green-600'); }
            else{ dot.classList.replace('bg-green-500','bg-orange-500'); dot.classList.remove('animate-pulse'); txt.innerText="Local"; txt.classList.remove('text-green-600'); }
        }

        // ACTIONS UI
        const UI = {
            switchTab: (id) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById('view-' + id).classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active', 'bg-indigo-700', 'text-white'));
                document.getElementById('btn-nav-' + id).classList.add('active', 'bg-indigo-700', 'text-white');
                if(id === 'pos') UI.renderPosSelects();
                if(id === 'history') UI.renderHistoryTable();
                if(id === 'config') UI.renderConfig();
                if(id === 'dashboard') UI.updateDashboard();
                if(window.innerWidth < 768) toggleMobileMenu();
            },
            renderPosSelects: () => {
                const sSel = document.getElementById('pos-seller');
                const pSel = document.getElementById('pos-product');
                sSel.innerHTML = DB.sellers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                pSel.innerHTML = '<option value="">Seleccione...</option>' + DB.products.map((p,i) => `<option value="${i}">${p.name}</option>`).join('');
                document.getElementById('pos-id').innerText = '#' + Math.floor(Math.random()*10000);
                
                // Si hay productos, calcular el primero por defecto para evitar NaN
                if(DB.products.length > 0) {
                    pSel.value = 0;
                    UI.updatePosCalc();
                }
            },
            updatePosCalc: () => {
                const idx = document.getElementById('pos-product').value;
                if(idx==="" || !DB.products[idx]) { 
                   document.getElementById('pos-cost').value='0.00'; document.getElementById('pos-price').value='0.00'; document.getElementById('pos-profit').innerText='0.00'; return; 
                }
                const p = DB.products[idx];
                document.getElementById('pos-cost').value = parseFloat(p.cost).toFixed(2);
                document.getElementById('pos-price').value = parseFloat(p.price).toFixed(2); // FORZAR PRECIO NUEVO
                UI.reCalcProfitOnly();
            },
            reCalcProfitOnly: () => {
                const c = parseFloat(document.getElementById('pos-cost').value)||0;
                const p = parseFloat(document.getElementById('pos-price').value)||0;
                const profit = p - c;
                document.getElementById('pos-profit').innerText = profit.toFixed(2);
                
                // Asegurar porcentajes vÃ¡lidos
                const ap = DB.config.adminPct || 0.60;
                const sp = DB.config.sellerPct || 0.40;
                
                document.getElementById('view-admin').innerText = (profit * ap).toFixed(2);
                document.getElementById('view-seller').innerText = (profit * sp).toFixed(2);
                document.getElementById('lbl-admin').innerText = (ap * 100).toFixed(0) + '%';
                document.getElementById('lbl-seller').innerText = (sp * 100).toFixed(0) + '%';
            },
            renderConfig: () => {
                document.getElementById('config-seller-list').innerHTML = DB.sellers.map(s => `<li class="flex justify-between items-center p-3 bg-slate-50 border rounded-lg text-sm"><div><span class="font-bold block">${s.name}</span><span class="text-xs text-slate-400">${s.phone}</span></div><button onclick="DATA.deleteItem('seller','${s.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></li>`).join('');
                document.getElementById('config-prod-list').innerHTML = DB.products.map(p => `<tr class="border-b"><td class="p-3 font-bold">${p.name}</td><td class="p-3 text-center">${p.cost}</td><td class="p-3 text-center font-bold text-indigo-600">${p.price}</td><td class="p-3 text-right"><button onclick="DATA.deleteItem('prod','${p.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('');
                document.getElementById('range-admin').value = (DB.config.adminPct||0.6) * 100;
                document.getElementById('range-seller').value = (DB.config.sellerPct||0.4) * 100;
                UI.updateConfigRange('admin');
            },
            updateConfigRange: (s) => { const v=parseInt(document.getElementById('range-'+s).value); document.getElementById(s==='admin'?'range-seller':'range-admin').value=100-v; },
            renderHistoryTable: () => {
                const sEl = document.getElementById('filter-seller');
                if(sEl.options.length <= 1) sEl.innerHTML = '<option value="">Todos</option>' + DB.sellers.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
                const start = document.getElementById('filter-start').value, end = document.getElementById('filter-end').value, sel = document.getElementById('filter-seller').value;
                let d = DB.sales;
                if(start) d = d.filter(x => x.date.split('T')[0] >= start);
                if(end) d = d.filter(x => x.date.split('T')[0] <= end);
                if(sel) d = d.filter(x => x.seller === sel);
                let tc=0, ts=0, rc=0; d.forEach(x => { if(x.status !== 'REFUNDED') { tc+=Number(x.comm); ts+=Number(x.price); } else { rc++; } });
                document.getElementById('liq-comm').innerText = 'S/ '+tc.toFixed(2); document.getElementById('liq-total').innerText = 'S/ '+ts.toFixed(2); document.getElementById('liq-count').innerText = d.length - rc; document.getElementById('liq-refunds').innerText = rc;
                document.getElementById('history-body').innerHTML = d.sort((a,b) => new Date(b.date) - new Date(a.date)).map(s => {
                    const isR = s.status === 'REFUNDED';
                    const vText = `ðŸŽ« KGB REGISTRO\n----------------\nðŸ“… ${new Date(s.date).toLocaleDateString()}\nðŸ‘¤ ${s.seller}\nðŸ“º ${s.product}\nðŸ’° COMISIÃ“N: S/ ${Number(s.comm).toFixed(2)}\nâœ… Verificado`;
                    const safeV = JSON.stringify(vText).replace(/"/g, '&quot;'); const cleanP = s.phone ? String(s.phone).replace(/\s/g,'') : '';
                    return `<tr class="border-b hover:bg-slate-100 ${isR ? 'refunded-row' : ''} transition"><td class="px-4 py-3"><div class="font-black text-xs uppercase text-indigo-900">${s.product}</div><div class="text-[10px] text-slate-500">${new Date(s.date).toLocaleDateString()} - ${s.seller}</div></td><td class="px-4 py-3"><div class="font-bold text-xs text-slate-700">${s.client||'-'}</div></td><td class="px-4 py-3 text-right font-black text-sm text-emerald-600">${isR?'0.00':'S/ '+Number(s.comm).toFixed(2)}</td><td class="px-4 py-3 text-center"><div class="flex justify-center gap-2">${isR?'<span class="text-[9px] font-bold text-red-600 bg-red-100 px-2 py-1 rounded">ANULADO</span>':`<button onclick="DATA.refundSale('${s.id}')" class="text-red-400 border rounded w-8 h-8 hover:bg-red-50"><i class="fa-solid fa-rotate-left"></i></button><button onclick='UI.copyV("${safeV}")' class="text-blue-500 border rounded w-8 h-8 hover:bg-blue-50"><i class="fa-regular fa-copy"></i></button><button onclick="window.open('https://wa.me/${cleanP}?text=${encodeURIComponent(vText)}','_blank')" class="text-green-500 border rounded w-8 h-8 hover:bg-green-50"><i class="fa-brands fa-whatsapp"></i></button>`}</div></td></tr>`;
                }).join('');
            },
            updateDashboard: () => {
                let t=0, a=0, s=0, c=0, ss={};
                DB.sales.forEach(x => {
                    if(x.status !== 'REFUNDED') {
                        t+=Number(x.price); a+=Number(x.admin); s+=Number(x.comm); c++;
                        if(!ss[x.seller]) ss[x.seller]=0; ss[x.seller]+=Number(x.comm);
                    }
                });
                document.getElementById('dash-total').innerText=t.toFixed(2); document.getElementById('dash-admin').innerText=a.toFixed(2); document.getElementById('dash-seller').innerText=s.toFixed(2); document.getElementById('dash-count').innerText=c;
                const ctx = document.getElementById('chartSellers').getContext('2d'); if(window.myChart) window.myChart.destroy();
                window.myChart = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(ss), datasets: [{label: 'ComisiÃ³n', data: Object.values(ss), backgroundColor: '#4f46e5', borderRadius: 6}] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
            },
            copyV: (t) => { const ta=document.createElement("textarea"); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast("Copiado"); },
            exportToExcel: () => { const ws=XLSX.utils.json_to_sheet(DB.sales); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Ventas"); XLSX.writeFile(wb,"Reporte_Cloud.xlsx"); },
            cancelEdit: () => {}
        };

        // DATA LAYER
        const DATA = {
            sync: async () => {
                if(API_URL.includes("PEGAR_AQUI")) { updateStatus(false); return; }
                showSync(true);
                try {
                    const res = await fetch(API_URL);
                    const json = await res.json();
                    if(json.status === "success") {
                        DB.sellers = json.data.sellers || [];
                        DB.products = json.data.products || [];
                        DB.sales = json.data.sales.map(r => ({ id: r.id, date: r.date, seller: r.seller, product: r.product, client: r.client, phone: r.phone, cost: r.cost, price: r.price, comm: r.comm, admin: r.admin, status: r.status }));
                        if(json.data.config) DB.config = json.data.config;
                        localStorage.setItem('kgb_v14_db', JSON.stringify(DB));
                        updateStatus(true);
                        const activeView = document.querySelector('.view-section:not(.hidden)').id.replace('view-','');
                        if(activeView === 'pos') UI.renderPosSelects(); else UI.switchTab(activeView);
                    }
                } catch(e) { console.error("Sync Error", e); updateStatus(false); }
                finally { showSync(false); }
            },
            post: async (payload) => {
                showSync(true);
                if(payload.action === 'sale') DB.sales.unshift({...payload, id: 'temp_'+Date.now()});
                if(payload.action === 'add_seller') DB.sellers.push(payload);
                if(payload.action === 'add_product') DB.products.push(payload);
                localStorage.setItem('kgb_v14_db', JSON.stringify(DB));
                UI.switchTab('pos'); // Simple refresh
                try {
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload), headers: { "Content-Type": "text/plain" } });
                    showToast("Sincronizado");
                    setTimeout(DATA.sync, 1000);
                } catch(e) { showToast("Guardado Local"); updateStatus(false); }
                finally { showSync(false); }
            },
            submitSale: () => {
                const idx = document.getElementById('pos-product').value; const sId = document.getElementById('pos-seller').value; if(idx==="" || sId==="") return alert("Faltan datos");
                const p = DB.products[idx]; const s = DB.sellers.find(x => x.id == sId);
                const price = parseFloat(document.getElementById('pos-price').value); const prof = price - p.cost;
                DATA.post({ action: 'sale', id: Date.now().toString(), date: new Date().toISOString(), seller: s.name, product: p.name, client: document.getElementById('pos-client').value, phone: document.getElementById('pos-phone').value, cost: p.cost, price: price, profit: prof, admin: prof * (DB.config.adminPct||0.6), comm: prof * (DB.config.sellerPct||0.4) });
                document.getElementById('pos-client').value=''; document.getElementById('pos-phone').value='';
            },
            addSeller: () => { const n = document.getElementById('new-seller-name').value; const ph = document.getElementById('new-seller-phone').value; if(!n) return; DATA.post({ action: 'add_seller', id: Date.now().toString(), name: n, phone: ph }); document.getElementById('new-seller-name').value=''; },
            addProd: () => { const n = document.getElementById('new-prod-name').value; const c = parseFloat(document.getElementById('new-prod-cost').value); const p = parseFloat(document.getElementById('new-prod-price').value); if(!n) return; DATA.post({ action: 'add_product', id: Date.now().toString(), name: n, cost: c, price: p }); document.getElementById('new-prod-name').value=''; },
            deleteItem: (type, id) => { if(!confirm("Â¿Eliminar?")) return; DATA.post({ action: type==='seller'?'delete_seller':'delete_product', id: id }); if(type==='seller') DB.sellers = DB.sellers.filter(x=>x.id != id); else DB.products = DB.products.filter(x=>x.id != id); localStorage.setItem('kgb_v14_db', JSON.stringify(DB)); UI.renderConfig(); },
            refundSale: (id) => { if(!confirm("Â¿Anular?")) return; DATA.post({ action: 'refund', id: id }); const s = DB.sales.find(x=>x.id == id); if(s) s.status = 'REFUNDED'; localStorage.setItem('kgb_v14_db', JSON.stringify(DB)); UI.renderHistoryTable(); },
            saveConfig: () => { DATA.post({ action: 'update_config', admin: document.getElementById('range-admin').value / 100, seller: document.getElementById('range-seller').value / 100 }); },
            forceSync: () => { DATA.sync(); }
        };

        // EXPOSE
        window.UI = UI; window.DATA = DATA; window.toggleMobileMenu = toggleMobileMenu;

        document.getElementById('range-admin').oninput = function() { const v = parseInt(this.value); document.getElementById('range-seller').value = 100 - v; };

        // START
        UI.renderPosSelects();
        DATA.sync();
    </script>
</body>
</html>
