<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KGB STREAMING v6.2 | HÃ­brido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f1f5f9; }
        .nav-item.active { background-color: #4338ca; color: white; border-left: 4px solid #a5b4fc; }
        .refunded-row { background-color: #fee2e2 !important; color: #991b1b !important; text-decoration: line-through; opacity: 0.7; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        #mobile-overlay { transition: opacity 0.3s ease-in-out; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="flex flex-col h-screen text-slate-800 bg-slate-50">

    <!-- OVERLAY MÃ“VIL -->
    <div id="mobile-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/60 z-40 hidden md:hidden backdrop-blur-sm"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 text-slate-300 flex flex-col z-50 shadow-2xl border-r border-slate-800 transform -translate-x-full md:translate-x-0 h-full">
        <div class="flex justify-between items-center p-4 md:hidden border-b border-slate-800 bg-slate-950">
            <span class="font-bold text-white text-xs uppercase tracking-widest">MenÃº</span>
            <button onclick="toggleMobileMenu()" class="text-white hover:text-red-400"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div class="h-28 flex items-center justify-center border-b border-slate-800 p-4 bg-slate-950 hidden md:flex">
            <!-- LOGO -->
            <img src="https://via.placeholder.com/200x80/0f172a/ffffff?text=KGB+APP" alt="Logo" class="max-h-20 object-contain opacity-80">
        </div>
        <div class="flex-1 overflow-y-auto px-4 py-6 space-y-3">
            <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 px-2">Operaciones</div>
            <button onclick="switchAppTab('pos')" id="nav-pos" class="nav-item w-full flex items-center px-4 py-3.5 rounded-xl hover:bg-slate-800 transition active bg-indigo-700 text-white font-bold shadow-lg"><i class="fa-solid fa-cart-shopping w-5 mr-3"></i> <span>Venta Nueva</span></button>
            <button onclick="switchAppTab('history')" id="nav-history" class="nav-item w-full flex items-center px-4 py-3.5 rounded-xl hover:bg-slate-800 transition"><i class="fa-solid fa-list-check w-5 mr-3"></i> <span>Historial</span></button>
            <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 px-2 mt-6">GestiÃ³n</div>
            <button onclick="switchAppTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center px-4 py-3.5 rounded-xl hover:bg-slate-800 transition"><i class="fa-solid fa-chart-pie w-5 mr-3"></i> <span>Reportes</span></button>
            <button onclick="switchAppTab('config')" id="nav-config" class="nav-item w-full flex items-center px-4 py-3.5 rounded-xl hover:bg-slate-800 transition"><i class="fa-solid fa-sliders w-5 mr-3"></i> <span>ConfiguraciÃ³n</span></button>
        </div>
        <div class="p-5 bg-black/20 border-t border-slate-800 text-center text-xs">
            <p class="font-bold text-slate-500">Sistema HÃ­brido v6.2</p>
        </div>
    </aside>

    <!-- HEADER TOP -->
    <header class="bg-white h-16 border-b border-gray-200 flex items-center justify-between px-4 md:ml-64 z-30 fixed top-0 right-0 left-0">
        <div class="flex items-center gap-4">
            <button onclick="toggleMobileMenu()" class="md:hidden text-slate-700 p-2 rounded-lg hover:bg-slate-100 transition"><i class="fa-solid fa-bars text-xl"></i></button>
            <div>
                <h1 class="text-lg md:text-xl font-black text-slate-900 tracking-tight leading-none">KGB <span class="text-indigo-600">STREAMING</span></h1>
            </div>
        </div>
        <!-- INDICADOR DE ESTADO -->
        <div id="status-indicator" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-gray-100 border border-gray-200">
            <div id="status-dot" class="w-2.5 h-2.5 rounded-full bg-red-500"></div>
            <span id="status-text" class="text-[10px] font-bold text-gray-500 uppercase">Modo Local</span>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 bg-slate-50 overflow-y-auto p-4 md:p-8 pt-20 md:ml-64 h-full">
        
        <div id="view-app" class="max-w-6xl mx-auto pb-20">
            
            <!-- POS -->
            <div id="tab-pos" class="app-tab w-full max-w-3xl mx-auto">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                        <h2 class="text-base md:text-lg font-black text-slate-800 flex gap-2"><i class="fa-solid fa-cash-register text-indigo-600"></i> REGISTRAR</h2>
                    </div>
                    <div class="p-6 md:p-8 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Vendedor</label><select id="pos-seller" class="w-full border p-3 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 bg-white"></select></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Plataforma</label><select id="pos-product" onchange="updatePosCalc()" class="w-full border p-3 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 bg-white"></select></div>
                        </div>
                        <div class="bg-slate-900 text-white rounded-2xl p-6 shadow-lg relative overflow-hidden">
                            <div class="grid grid-cols-3 gap-2 text-center relative z-10">
                                <div><p class="text-[9px] text-slate-400 font-bold uppercase mb-1">COSTO</p><input id="pos-cost" readonly class="w-full bg-transparent text-center font-mono text-lg font-bold text-slate-400 outline-none" value="0.00"></div>
                                <div class="border-x border-slate-700"><p class="text-[9px] text-indigo-400 font-bold uppercase mb-1">VENTA</p><input id="pos-price" type="number" oninput="reCalcProfitOnly()" class="w-full bg-transparent text-center font-mono text-2xl font-bold text-white outline-none" value="0.00"></div>
                                <div><p class="text-[9px] text-emerald-400 font-bold uppercase mb-1">GANANCIA</p><p id="pos-profit" class="font-mono text-xl font-bold text-emerald-400 mt-1">0.00</p></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="pos-client" placeholder="Nombre Cliente" class="border p-3 rounded-xl text-sm w-full outline-none">
                            <input type="tel" id="pos-phone" placeholder="TelÃ©fono Cliente" class="border p-3 rounded-xl text-sm w-full outline-none">
                        </div>
                        <button id="btn-submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transition text-sm uppercase tracking-widest active:scale-[0.98]">Confirmar Venta</button>
                    </div>
                </div>
            </div>

            <!-- HISTORY -->
            <div id="tab-history" class="app-tab hidden w-full">
                <h2 class="text-xl font-black text-slate-800 mb-4 flex gap-2 items-center"><i class="fa-solid fa-list-check text-indigo-500"></i> Historial</h2>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200 mb-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 items-end">
                        <div class="col-span-1"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Desde</label><input type="date" id="filter-start" onchange="renderHistoryTable()" class="w-full border rounded-lg p-2 text-xs focus:border-indigo-500 outline-none"></div>
                        <div class="col-span-1"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Hasta</label><input type="date" id="filter-end" onchange="renderHistoryTable()" class="w-full border rounded-lg p-2 text-xs focus:border-indigo-500 outline-none"></div>
                        <div class="col-span-2 md:col-span-1"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Vendedor</label><select id="filter-seller" onchange="renderHistoryTable()" class="w-full border rounded-lg p-2 text-xs focus:border-indigo-500 outline-none"></select></div>
                        <button onclick="exportToExcel()" class="col-span-2 md:col-span-1 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-bold shadow flex justify-center items-center gap-2 text-xs h-[34px] transition"><i class="fa-solid fa-file-excel"></i> Exportar</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border overflow-hidden flex flex-col h-[500px]">
                        <div class="overflow-x-auto flex-1">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead class="bg-slate-50 text-xs text-slate-500 uppercase sticky top-0 z-10 font-bold"><tr><th class="p-4">Detalle</th><th class="p-4">Cliente</th><th class="p-4 text-right">ComisiÃ³n</th><th class="p-4 text-center">AcciÃ³n</th></tr></thead>
                                <tbody id="history-table-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="lg:col-span-1 bg-slate-900 text-white p-6 rounded-3xl shadow-xl sticky top-0 h-fit">
                        <h3 class="font-bold text-base mb-4 flex gap-2"><i class="fa-solid fa-wallet text-indigo-400"></i> Caja Real</h3>
                        <div class="space-y-3 mb-6 border-b border-slate-700 pb-4">
                            <div class="flex justify-between"><span class="text-slate-400 text-xs">Ventas</span><span class="font-mono font-bold" id="liq-total">0.00</span></div>
                            <div class="flex justify-between"><span class="text-slate-400 text-xs">Ops</span><span class="font-mono font-bold" id="liq-count">0</span></div>
                            <div class="flex justify-between text-red-400"><span class="text-xs">Reembolsos</span><span class="font-mono font-bold" id="liq-refunds">0</span></div>
                        </div>
                        <div class="bg-indigo-600 p-4 rounded-xl text-center"><p class="text-[10px] font-bold uppercase mb-1 text-indigo-200">A PAGAR</p><p class="text-3xl font-black font-mono" id="liq-comm">0.00</p></div>
                    </div>
                </div>
            </div>

            <!-- 3. CONFIG -->
            <div id="tab-config" class="app-tab hidden w-full pb-20">
                <h2 class="text-xl font-black text-slate-800 mb-6">CONFIGURACIÃ“N</h2>
                <div class="flex flex-col gap-6">
                    <!-- Plataformas -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-slate-700 mb-4 text-xs uppercase tracking-widest border-b pb-2 flex justify-between"><span>1. Plataformas</span> <span id="prod-mode-badge" class="text-[9px] bg-slate-100 px-2 py-0.5 rounded text-slate-400">CREAR</span></h3>
                        <div class="bg-indigo-50 p-4 rounded-xl mb-4 border border-indigo-100 flex flex-col md:flex-row gap-2">
                            <input type="hidden" id="edit-prod-id"><input type="text" id="new-prod-name" placeholder="Nombre" class="flex-grow border rounded-lg px-3 py-2 text-sm"><div class="flex gap-2"><input type="number" id="new-prod-cost" placeholder="Costo" class="w-20 border rounded-lg px-2 py-2 text-sm text-center"><input type="number" id="new-prod-price" placeholder="Venta" class="w-20 border rounded-lg px-2 py-2 text-sm text-center"><button id="btn-prod-action" class="bg-indigo-600 text-white px-4 rounded-lg font-bold text-sm shadow-md">Agregar</button><button id="btn-prod-cancel" onclick="cancelEdit('prod')" class="bg-slate-300 text-slate-600 px-3 rounded-lg font-bold text-sm hidden"><i class="fa-solid fa-xmark"></i></button></div>
                        </div>
                        <div class="overflow-y-auto max-h-60 border rounded-xl"><table class="w-full text-sm text-left"><tbody id="config-prod-list" class="divide-y divide-gray-100 text-slate-700"></tbody></table></div>
                    </div>
                    <!-- Vendedores -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-slate-700 mb-4 text-xs uppercase tracking-widest border-b pb-2 flex justify-between"><span>2. Vendedores</span> <span id="seller-mode-badge" class="text-[9px] bg-slate-100 px-2 py-0.5 rounded text-slate-400">CREAR</span></h3>
                        <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-100 flex flex-col md:flex-row gap-2">
                            <input type="hidden" id="edit-seller-id"><input type="text" id="new-seller-name" placeholder="Nombre" class="flex-grow border rounded-lg px-3 py-2 text-sm"><div class="flex gap-2"><input type="tel" id="new-seller-phone" placeholder="Celular" class="w-32 border rounded-lg px-3 py-2 text-sm"><button id="btn-seller-action" class="bg-slate-800 text-white px-4 rounded-lg font-bold text-sm shadow-md">Crear</button><button id="btn-seller-cancel" onclick="cancelEdit('seller')" class="bg-slate-300 text-slate-600 px-3 rounded-lg font-bold text-sm hidden"><i class="fa-solid fa-xmark"></i></button></div>
                        </div>
                        <div class="overflow-y-auto max-h-60"><ul id="config-seller-list" class="space-y-2"></ul></div>
                    </div>
                    <!-- DistribuciÃ³n -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200"><h3 class="font-bold text-slate-700 mb-4 text-xs uppercase tracking-widest border-b pb-2">3. DistribuciÃ³n</h3><div class="space-y-4"><div><label class="flex justify-between text-xs font-bold text-slate-500 mb-1">Admin: <span id="display-admin-pct" class="text-indigo-600">60%</span></label><input type="range" id="range-admin" min="0" max="100" value="60" oninput="updateConfigRange('admin')" class="w-full h-1.5 bg-slate-200 rounded-lg"></div><div><label class="flex justify-between text-xs font-bold text-slate-500 mb-1">Vendedor: <span id="display-seller-pct" class="text-emerald-600">40%</span></label><input type="range" id="range-seller" min="0" max="100" value="40" oninput="updateConfigRange('seller')" class="w-full h-1.5 bg-slate-200 rounded-lg"></div><button id="btn-save-config" class="w-full py-2 bg-slate-900 text-white rounded-lg text-xs font-bold uppercase tracking-widest">Guardar Cambios</button></div></div>
                </div>
            </div>

            <!-- 4. DASHBOARD -->
            <div id="tab-dashboard" class="app-tab hidden w-full">
                <h2 class="text-xl font-black text-slate-800 mb-6">REPORTES</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase">Ventas</p><p id="dash-total" class="text-xl font-black text-slate-800">0.00</p></div>
                    <div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-indigo-500 font-bold uppercase">Utilidad</p><p id="dash-admin" class="text-xl font-black text-indigo-600">0.00</p></div>
                    <div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-emerald-500 font-bold uppercase">Comisiones</p><p id="dash-seller" class="text-xl font-black text-emerald-600">0.00</p></div>
                    <div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase">Ops</p><p id="dash-count" class="text-xl font-black text-slate-800">0</p></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border shadow-sm h-64 md:h-96 w-full"><canvas id="chartSellers"></canvas></div>
            </div>
        </div>
    </main>

    <div id="toast" class="fixed bottom-8 right-1/2 translate-x-1/2 md:translate-x-0 md:right-8 bg-slate-900 text-white px-5 py-3 rounded-xl shadow-2xl translate-y-40 transition-transform duration-500 z-50 flex items-center gap-3 whitespace-nowrap"><div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white"><i class="fa-solid fa-check text-xs"></i></div><p class="text-xs md:text-sm font-bold">Â¡Hecho!</p></div>

    <!-- SCRIPT HÃBRIDO (LOCAL + CLOUD) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ==========================================
        //  CONFIGURACIÃ“N FIREBASE (PEGAR AQUÃ)
        // ==========================================
        const firebaseConfig = 
            {
  apiKey: "AIzaSyDrMs4FRGpGeVGw1gWLltOWZlQVeYFpQf8",
  authDomain: "kgb-system.firebaseapp.com",
  projectId: "kgb-system",
  storageBucket: "kgb-system.firebasestorage.app",
  messagingSenderId: "850376757764",
  appId: "1:850376757764:web:0976c465dd91a236405b51",
  measurementId: "G-6SCRBS3GQ9"

        };
        // ==========================================

        // --- SISTEMA DUAL ---
        let db = null;
        let STATE = JSON.parse(localStorage.getItem('kgb_local_db')) || { sellers: [], products: [], sales: [], config: { adminPct: 0.60, sellerPct: 0.40 } };

        // 1. Intentar ConexiÃ³n Nube
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                setupCloudListeners();
                updateStatus(true);
            } else {
                updateStatus(false);
            }
        } catch (e) { console.error("Modo Offline"); updateStatus(false); }

        function updateStatus(isCloud) {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text');
            if (isCloud) {
                dot.className = "w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse";
                txt.innerText = "MODO NUBE";
                txt.classList.replace('text-gray-500', 'text-green-600');
            } else {
                dot.className = "w-2.5 h-2.5 rounded-full bg-red-500";
                txt.innerText = "MODO LOCAL";
            }
            refreshUI(); // Cargar datos iniciales
        }

        function saveLocal() {
            localStorage.setItem('kgb_local_db', JSON.stringify(STATE));
            refreshUI();
        }

        // --- CLOUD SYNC ---
        function setupCloudListeners() {
            onSnapshot(collection(db, "kgb_sellers"), (s) => { 
                STATE.sellers = s.docs.map(d => ({id: d.id, ...d.data()})).filter(x => x.active); 
                saveLocal(); 
            });
            onSnapshot(collection(db, "kgb_products"), (s) => { 
                STATE.products = s.docs.map(d => ({id: d.id, ...d.data()})).filter(x => x.active); 
                saveLocal(); 
            });
            const q = query(collection(db, "kgb_sales"), orderBy("date", "desc"));
            onSnapshot(q, (s) => { 
                STATE.sales = s.docs.map(d => ({id: d.id, ...d.data()})); 
                saveLocal(); 
            });
            onSnapshot(doc(db, "kgb_config", "main"), (s) => { 
                if(s.exists()) { STATE.config = s.data(); saveLocal(); updateConfigInputs(); }
            });
        }

        // --- CRUD UNIFICADO (NUBE O LOCAL) ---
        async function saveData(collectionName, data) {
            // 1. Guardar Localmente Primero (Optimistic UI)
            if(collectionName === 'kgb_sales') STATE.sales.unshift({...data, id: Date.now().toString()}); // Temp ID
            // ... lÃ³gica local simplificada para demo ...
            saveLocal();

            // 2. Intentar Nube
            if (db) {
                try {
                    if (collectionName === 'kgb_config') await setDoc(doc(db, "kgb_config", "main"), data);
                    else await addDoc(collection(db, collectionName), data);
                    showToast("Guardado en Nube");
                } catch (e) { showToast("Error Nube -> Guardado Local"); }
            } else {
                showToast("Guardado Localmente");
            }
        }
        
        async function updateData(collectionName, id, data) {
            if (db) await updateDoc(doc(db, collectionName, id), data);
            // Actualizar local
            if (collectionName === 'kgb_sellers') { const i = STATE.sellers.findIndex(x=>x.id===id); if(i>-1) Object.assign(STATE.sellers[i], data); }
            if (collectionName === 'kgb_products') { const i = STATE.products.findIndex(x=>x.id===id); if(i>-1) Object.assign(STATE.products[i], data); }
            saveLocal();
        }

        // --- UI UTILS ---
        window.toggleMobileMenu = () => { const s=document.getElementById('sidebar'), o=document.getElementById('mobile-overlay'); if(s.classList.contains('-translate-x-full')){s.classList.remove('-translate-x-full');o.classList.remove('hidden');}else{s.classList.add('-translate-x-full');o.classList.add('hidden');} };
        window.closeMobileMenu = () => { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('mobile-overlay').classList.add('hidden'); };
        window.switchAppTab = (t) => { document.querySelectorAll('.app-tab').forEach(e=>e.classList.add('hidden')); document.getElementById('tab-'+t).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active','bg-indigo-700','text-white')); document.getElementById('nav-'+t).classList.add('active','bg-indigo-700','text-white'); if(t==='history') renderHistoryTable(); if(window.innerWidth<768) closeMobileMenu(); };
        window.showToast = (m) => { const t=document.getElementById('toast');t.querySelector('p').innerText=m;t.classList.remove('translate-y-40');setTimeout(()=>t.classList.add('translate-y-40'),3000); };
        function refreshUI() { renderPosSelects(); renderFilterSeller(); renderSellerList(); renderProductList(); updatePosCalc(); updateDashboard(); }

        // --- POS ---
        window.updatePosCalc = () => {
            const idx = document.getElementById('pos-product').value;
            if(idx === "" || !STATE.products[idx]) { document.getElementById('pos-cost').value='0.00'; document.getElementById('pos-price').value='0.00'; document.getElementById('pos-profit').innerText='0.00'; return; }
            const p = STATE.products[idx]; document.getElementById('pos-cost').value = p.cost.toFixed(2);
            let curr = parseFloat(document.getElementById('pos-price').value); if(curr===0 || isNaN(curr)) { curr = p.price; document.getElementById('pos-price').value=curr.toFixed(2); }
            reCalcProfitOnly();
        }
        window.reCalcProfitOnly = () => { const c=parseFloat(document.getElementById('pos-cost').value)||0; const p=parseFloat(document.getElementById('pos-price').value)||0; document.getElementById('pos-profit').innerText=(p-c).toFixed(2); };

        document.getElementById('btn-submit').onclick = async () => {
            const idx = document.getElementById('pos-product').value; const sId = document.getElementById('pos-seller').value; if(idx==="" || sId==="") return alert("Faltan datos");
            const p = STATE.products[idx]; const s = STATE.sellers.find(x => x.id === sId) || {name: 'Local', phone: ''}; 
            const price = parseFloat(document.getElementById('pos-price').value); const prof = price - p.cost;

            const sale = {
                date: new Date().toISOString(), seller: s.name, sellerPhone: s.phone, product: p.name, cost: p.cost, price: price, profit: prof,
                admin: prof*STATE.config.adminPct, comm: prof*STATE.config.sellerPct, client: document.getElementById('pos-client').value, phone: document.getElementById('pos-phone').value, status: 'active'
            };
            await saveData('kgb_sales', sale);
            document.getElementById('pos-client').value=''; document.getElementById('pos-phone').value='';
        };

        // --- ACTIONS ---
        document.getElementById('btn-seller-action').onclick = async () => {
            const id = document.getElementById('edit-seller-id').value; const name = document.getElementById('new-seller-name').value; const phone = document.getElementById('new-seller-phone').value; if(!name) return;
            if(id) { await updateData('kgb_sellers', id, {name, phone}); showToast("Editado"); cancelEdit('seller'); } 
            else { await saveData('kgb_sellers', { name, phone, active: true }); }
            document.getElementById('new-seller-name').value=''; document.getElementById('new-seller-phone').value='';
        };
        document.getElementById('btn-prod-action').onclick = async () => {
            const id = document.getElementById('edit-prod-id').value; const name = document.getElementById('new-prod-name').value; const cost = parseFloat(document.getElementById('new-prod-cost').value); const price = parseFloat(document.getElementById('new-prod-price').value); if(!name) return;
            if(id) { await updateData('kgb_products', id, {name, cost, price}); showToast("Editado"); cancelEdit('prod'); } 
            else { await saveData('kgb_products', { name, cost, price, active: true }); }
            document.getElementById('new-prod-name').value='';
        };
        document.getElementById('btn-save-config').onclick = async () => { 
            const d = { adminPct: document.getElementById('range-admin').value / 100, sellerPct: document.getElementById('range-seller').value / 100 };
            await saveData('kgb_config', d); 
        };

        window.deleteItem = async (c, id) => { if(confirm("Â¿Eliminar?")) await updateData(c, id, { active: false }); };
        window.refundSale = async (id) => { if(confirm("Â¿Anular?")) await updateData('kgb_sales', id, { status: 'REFUNDED' }); };

        window.prepareEdit = (t, id) => {
            if(t==='seller') { const s = STATE.sellers.find(x=>x.id===id); document.getElementById('edit-seller-id').value=id; document.getElementById('new-seller-name').value=s.name; document.getElementById('new-seller-phone').value=s.phone; document.getElementById('btn-seller-action').innerText="Actualizar"; document.getElementById('btn-seller-cancel').classList.remove('hidden'); document.getElementById('seller-mode-badge').innerText="EDITANDO"; }
            else { const p = STATE.products.find(x=>x.id===id); document.getElementById('edit-prod-id').value=id; document.getElementById('new-prod-name').value=p.name; document.getElementById('new-prod-cost').value=p.cost; document.getElementById('new-prod-price').value=p.price; document.getElementById('btn-prod-action').innerText="Actualizar"; document.getElementById('btn-prod-cancel').classList.remove('hidden'); document.getElementById('prod-mode-badge').innerText="EDITANDO"; }
        };
        window.cancelEdit = (t) => { document.getElementById(t==='seller'?'edit-seller-id':'edit-prod-id').value=''; document.getElementById(t==='seller'?'new-seller-name':'new-prod-name').value=''; document.getElementById(`btn-${t}-action`).innerText=t==='prod'?'Agregar':'Crear'; document.getElementById(`btn-${t}-cancel`).classList.add('hidden'); document.getElementById(`${t}-mode-badge`).innerText="CREAR"; };

        // Renders
        function renderPosSelects() { const sel = document.getElementById('pos-seller'); const pro = document.getElementById('pos-product'); sel.innerHTML = STATE.sellers.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); pro.innerHTML = '<option value="">Seleccione...</option>' + STATE.products.map((p, i) => `<option value="${i}">${p.name}</option>`).join(''); }
        function renderSellerList() { document.getElementById('config-seller-list').innerHTML = STATE.sellers.map(s => `<li class="flex justify-between items-center p-3 bg-slate-50 border rounded-lg text-sm"><div><span class="font-bold block">${s.name}</span><span class="text-xs text-slate-400">${s.phone}</span></div><div class="flex gap-2"><button onclick="prepareEdit('seller','${s.id}')" class="text-blue-500"><i class="fa-solid fa-pen"></i></button><button onclick="deleteItem('kgb_sellers','${s.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></div></li>`).join(''); }
        function renderProductList() { document.getElementById('config-prod-list').innerHTML = STATE.products.map(p => `<tr class="border-b"><td class="p-3 font-bold">${p.name}</td><td class="p-3 text-center">${p.cost}</td><td class="p-3 text-center font-bold text-indigo-600">${p.price}</td><td class="p-3 text-right"><button onclick="prepareEdit('prod','${p.id}')" class="text-blue-500 mr-2"><i class="fa-solid fa-pen"></i></button><button onclick="deleteItem('kgb_products','${p.id}')" class="text-red-500"><i class="fa-solid fa-trash"></i></button></td></tr>`).join(''); }
        function updateConfigInputs() { document.getElementById('range-admin').value = STATE.config.adminPct * 100; document.getElementById('range-seller').value = STATE.config.sellerPct * 100; }
        
        window.renderHistoryTable = () => {
            const start = document.getElementById('filter-start').value; const end = document.getElementById('filter-end').value; const sId = document.getElementById('filter-seller').value;
            let d = STATE.sales; if(start) d = d.filter(x => x.date.split('T')[0] >= start); if(end) d = d.filter(x => x.date.split('T')[0] <= end);
            if(sId) { const sName = STATE.sellers.find(x => x.id === sId)?.name; if(sName) d = d.filter(x => x.seller === sName); }
            
            let tc=0, ts=0, rc=0; d.forEach(x => { if(x.status !== 'REFUNDED') { tc += x.comm; ts += x.price; } else { rc++; } });
            document.getElementById('liq-comm').innerText = 'S/ ' + tc.toFixed(2); document.getElementById('liq-total').innerText = 'S/ ' + ts.toFixed(2); document.getElementById('liq-count').innerText = d.length - rc; document.getElementById('liq-refunds').innerText = rc;

            document.getElementById('history-table-body').innerHTML = d.map(s => {
                const isR = s.status === 'REFUNDED';
                const vText = `ðŸŽ« KGB REGISTRO\n----------------\nðŸ“… ${new Date(s.date).toLocaleDateString()}\nðŸ‘¤ ${s.seller}\nðŸ“º ${s.product}\nðŸ’° COMISIÃ“N: S/ ${Number(s.comm).toFixed(2)}\nâœ… Verificado`;
                const safeV=JSON.stringify(vText).replace(/"/g,'&quot;'); const cleanP = s.sellerPhone ? String(s.sellerPhone).replace(/\s/g, '') : '';
                return `<tr class="border-b hover:bg-slate-50 ${isR?'refunded-row':''} transition"><td class="px-4 py-3"><div class="font-black text-xs uppercase text-indigo-900">${s.product}</div><div class="text-[10px] text-slate-500">${new Date(s.date).toLocaleDateString()} - ${s.seller}</div></td><td class="px-4 py-3"><div class="font-bold text-xs text-slate-700">${s.client||'-'}</div></td><td class="px-4 py-3 text-right font-black text-sm text-emerald-600">${isR?'0.00':'S/ '+Number(s.comm).toFixed(2)}</td><td class="px-4 py-3 text-center"><div class="flex justify-center gap-2">${isR?'<span class="text-[9px] font-bold text-red-600 bg-red-100 px-2 py-1 rounded">DEV</span>':`<button onclick="refundSale('${s.id}')" class="text-red-400 border rounded w-8 h-8 hover:bg-red-50"><i class="fa-solid fa-rotate-left"></i></button><button onclick='copyV("${safeV}")' class="text-blue-500 border rounded w-8 h-8 hover:bg-blue-50"><i class="fa-regular fa-copy"></i></button><button onclick="window.open('https://wa.me/${cleanP}?text=${encodeURIComponent(vText)}','_blank')" class="text-green-500 border rounded w-8 h-8 hover:bg-green-50"><i class="fa-brands fa-whatsapp"></i></button>`}</div></td></tr>`;
            }).join('');
        };
        window.copyV = (t) => { const ta=document.createElement("textarea"); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast("Copiado"); };
        function renderFilterSeller() { const sel = document.getElementById('filter-seller'); sel.innerHTML = '<option value="">Todos</option>' + STATE.sellers.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); }
        function updateDashboard(){let t=0,a=0,s=0,c=0,ss={};STATE.sales.forEach(x=>{if(x.status!=='REFUNDED'){t+=Number(x.price);a+=Number(x.admin);s+=Number(x.comm);c++;if(!ss[x.seller])ss[x.seller]=0;ss[x.seller]+=Number(x.comm);}});document.getElementById('dash-total').innerText=t.toFixed(2);document.getElementById('dash-admin').innerText=a.toFixed(2);document.getElementById('dash-seller').innerText=s.toFixed(2);document.getElementById('dash-count').innerText=c;const ctx=document.getElementById('chartSellers').getContext('2d');new Chart(ctx,{type:'bar',data:{labels:Object.keys(ss),datasets:[{label:'ComisiÃ³n',data:Object.values(ss),backgroundColor:'#4f46e5',borderRadius:6}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});}
        window.exportToExcel = () => { const ws=XLSX.utils.json_to_sheet(STATE.sales); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Ventas"); XLSX.writeFile(wb,"Reporte_Cloud.xlsx"); };

        document.getElementById('range-admin').oninput = function() { const v = parseInt(this.value); document.getElementById('range-seller').value = 100 - v; };

        // INIT LOAD
        refreshUI();
    </script>
</body>
</html>
