<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KGB STREAMING v9.0 | Unlocked</title>
    <!-- LIBRERÃAS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Montserrat', sans-serif; background-color: #f1f5f9; }
        .nav-item.active { background-color: #4338ca; color: white; border-left: 4px solid #a5b4fc; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); }
        .refunded-row { background-color: #fee2e2 !important; color: #991b1b !important; text-decoration: line-through; opacity: 0.7; }
        
        /* Sidebar y Transiciones */
        #sidebar { transition: transform 0.3s ease-in-out; }
        #mobile-overlay { transition: opacity 0.3s ease-in-out; }
        
        /* Loader no bloqueante por defecto */
        #loader { z-index: 100; transition: opacity 0.3s; pointer-events: none; opacity: 0; }
        #loader.active { pointer-events: all; opacity: 1; }

        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden text-slate-800 bg-slate-50">

    <!-- LOADER (Inicia oculto) -->
    <div id="loader" class="fixed inset-0 bg-slate-900/90 flex flex-col items-center justify-center text-white">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500 mb-4"></div>
        <h2 class="text-xl font-bold tracking-widest">PROCESANDO...</h2>
    </div>

    <!-- OVERLAY MÃ“VIL -->
    <div id="mobile-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/60 z-40 hidden md:hidden backdrop-blur-sm"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 text-slate-300 flex flex-col z-50 shadow-2xl border-r border-slate-800 transform -translate-x-full md:translate-x-0 h-full transition-transform duration-300">
        
        <!-- Mobile Close Header -->
        <div class="flex justify-between items-center p-4 md:hidden border-b border-slate-800 bg-slate-950">
            <span class="font-bold text-white text-xs uppercase tracking-widest">MenÃº</span>
            <button onclick="toggleMobileMenu()" class="text-white hover:text-red-400 transition"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <!-- Logo -->
        <div class="h-28 flex items-center justify-center border-b border-slate-800 p-4 bg-slate-950 hidden md:flex relative group">
            <div class="text-center">
                <div class="w-12 h-12 bg-indigo-600 rounded-xl flex items-center justify-center text-white text-2xl shadow-lg mx-auto mb-2"><i class="fa-solid fa-play"></i></div>
                <h1 class="text-sm font-black text-white tracking-widest">KGB SYSTEM</h1>
            </div>
        </div>

        <!-- NAVEGACIÃ“N (BOTONES) -->
        <div class="flex-1 overflow-y-auto px-4 py-6 space-y-3">
            <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 px-2">Operaciones</div>
            <!-- Los onclick llaman a funciones globales definidas en el SCRIPT UI al final -->
            <button onclick="switchTab('pos')" id="nav-pos" class="nav-item active w-full flex items-center px-4 py-3.5 rounded-xl hover:bg-slate-800 transition active bg-indigo-700 text-white font-bold shadow-lg">
                <i class="fa-solid fa-cart-shopping w-5 mr-3"></i> <span>Venta Nueva</span>
            </button>
            <button onclick="switchTab('history')" id="nav-history" class="nav-item w-full flex items-center px-4 py-3.5 rounded-xl hover:bg-slate-800 transition">
                <i class="fa-solid fa-list-check w-5 mr-3"></i> <span>Historial</span>
            </button>
            
            <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 px-2 mt-6">GestiÃ³n</div>
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center px-4 py-3.5 rounded-xl hover:bg-slate-800 transition">
                <i class="fa-solid fa-chart-pie w-5 mr-3"></i> <span>Reportes</span>
            </button>
            <button onclick="switchTab('config')" id="nav-config" class="nav-item w-full flex items-center px-4 py-3.5 rounded-xl hover:bg-slate-800 transition">
                <i class="fa-solid fa-sliders w-5 mr-3"></i> <span>ConfiguraciÃ³n</span>
            </button>
        </div>

        <div class="p-5 bg-black/20 border-t border-slate-800 text-center text-xs">
            <div class="flex items-center justify-center gap-2 mb-1">
                <div id="status-dot" class="w-2.5 h-2.5 rounded-full bg-orange-500"></div>
                <span id="status-text" class="font-bold text-slate-300">Iniciando...</span>
            </div>
            <p class="text-indigo-500 font-bold">JosÃ© Vizcarra</p>
        </div>
    </aside>

    <!-- HEADER TOP -->
    <header class="bg-white h-16 border-b border-gray-200 flex items-center justify-between px-4 md:ml-64 z-30 fixed top-0 right-0 left-0 transition-all">
        <div class="flex items-center gap-4">
            <button onclick="toggleMobileMenu()" class="md:hidden text-slate-700 p-2 rounded-lg hover:bg-slate-100 transition focus:outline-none">
                <i class="fa-solid fa-bars text-xl"></i>
            </button>
            <div>
                <h1 class="text-lg md:text-xl font-black text-slate-900 tracking-tight leading-none">KGB <span class="text-indigo-600">STREAMING</span></h1>
                <p class="text-[9px] text-slate-400 font-bold hidden sm:block">Panel de Control v9.0</p>
            </div>
        </div>
        <div class="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full border hidden sm:block">
            <span id="clock">--:--</span>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 bg-slate-50 overflow-y-auto p-4 md:p-8 pt-20 md:ml-64 h-full">
        <div class="max-w-6xl mx-auto pb-20">
            
            <!-- 1. POS -->
            <div id="tab-pos" class="app-tab w-full max-w-3xl mx-auto">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                        <h2 class="text-base md:text-lg font-black text-slate-800 flex gap-2"><i class="fa-solid fa-cash-register text-indigo-600"></i> REGISTRAR</h2>
                        <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded font-bold">ID: <span id="pos-id">#--</span></span>
                    </div>
                    <div class="p-6 md:p-8 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Vendedor</label><select id="pos-seller" class="w-full border p-3 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 bg-white transition"></select></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Plataforma</label><select id="pos-product" onchange="updatePosCalc()" class="w-full border p-3 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 bg-white transition"></select></div>
                        </div>
                        <div class="bg-slate-900 text-white rounded-2xl p-6 shadow-lg relative overflow-hidden">
                            <div class="grid grid-cols-3 gap-2 text-center relative z-10">
                                <div><p class="text-[9px] text-slate-400 font-bold uppercase mb-1">COSTO</p><input id="pos-cost" readonly class="w-full bg-transparent text-center font-mono text-lg font-bold text-slate-400 outline-none" value="0.00"></div>
                                <div class="border-x border-slate-700"><p class="text-[9px] text-indigo-400 font-bold uppercase mb-1">VENTA</p><input id="pos-price" type="number" oninput="reCalcProfitOnly()" class="w-full bg-transparent text-center font-mono text-2xl font-bold text-white outline-none focus:text-indigo-400 transition" value="0.00"></div>
                                <div><p class="text-[9px] text-emerald-400 font-bold uppercase mb-1">GANANCIA</p><p id="pos-profit" class="font-mono text-xl font-bold text-emerald-400 mt-1">0.00</p></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" id="pos-client" placeholder="Nombre Cliente" class="border p-3 rounded-xl text-sm w-full outline-none focus:border-indigo-500 transition">
                            <input type="tel" id="pos-phone" placeholder="TelÃ©fono Cliente" class="border p-3 rounded-xl text-sm w-full outline-none focus:border-indigo-500 transition">
                        </div>
                        <button id="btn-submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg transition text-sm uppercase tracking-widest active:scale-[0.98]">Confirmar Venta</button>
                    </div>
                </div>
            </div>

            <!-- 2. HISTORY -->
            <div id="tab-history" class="app-tab hidden w-full">
                <h2 class="text-xl font-black text-slate-800 mb-4 flex gap-2 items-center"><i class="fa-solid fa-list-check text-indigo-500"></i> Historial (Nube)</h2>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-200 mb-6">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 items-end">
                        <div class="col-span-1"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Desde</label><input type="date" id="filter-start" onchange="renderHistoryTable()" class="w-full border rounded-lg p-2 text-xs outline-none focus:border-indigo-500"></div>
                        <div class="col-span-1"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Hasta</label><input type="date" id="filter-end" onchange="renderHistoryTable()" class="w-full border rounded-lg p-2 text-xs outline-none focus:border-indigo-500"></div>
                        <div class="col-span-2 md:col-span-1"><label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">Vendedor</label><select id="filter-seller" onchange="renderHistoryTable()" class="w-full border rounded-lg p-2 text-xs outline-none focus:border-indigo-500"></select></div>
                        <button onclick="exportToExcel()" class="col-span-2 md:col-span-1 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-bold shadow flex justify-center items-center gap-2 text-xs h-[34px] transition"><i class="fa-solid fa-file-excel"></i> Exportar</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border overflow-hidden flex flex-col h-[500px]">
                        <div class="overflow-x-auto flex-1">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead class="bg-slate-50 text-xs text-slate-500 uppercase sticky top-0 z-10 font-bold"><tr><th class="p-4">Detalle</th><th class="p-4">Cliente</th><th class="p-4 text-right">ComisiÃ³n</th><th class="p-4 text-center">AcciÃ³n</th></tr></thead>
                                <tbody id="history-table-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="lg:col-span-1 bg-slate-900 text-white p-6 rounded-3xl shadow-xl sticky top-0 h-fit">
                        <h3 class="font-bold text-base mb-4 flex gap-2"><i class="fa-solid fa-wallet text-indigo-400"></i> Caja Real</h3>
                        <div class="space-y-3 mb-6 border-b border-slate-700 pb-4">
                            <div class="flex justify-between"><span class="text-slate-400 text-xs">Ventas</span><span class="font-mono font-bold" id="liq-total">0.00</span></div>
                            <div class="flex justify-between"><span class="text-slate-400 text-xs">Ops</span><span class="font-mono font-bold" id="liq-count">0</span></div>
                            <div class="flex justify-between text-red-400"><span class="text-xs">Reembolsos</span><span class="font-mono font-bold" id="liq-refunds">0</span></div>
                        </div>
                        <div class="bg-indigo-600 p-4 rounded-xl text-center"><p class="text-[10px] font-bold uppercase mb-1 text-indigo-200">A PAGAR</p><p class="text-3xl font-black font-mono" id="liq-comm">0.00</p></div>
                    </div>
                </div>
            </div>

            <!-- 3. CONFIG -->
            <div id="tab-config" class="app-tab hidden w-full pb-20">
                <h2 class="text-xl font-black text-slate-800 mb-6">CONFIGURACIÃ“N</h2>
                <div class="flex flex-col gap-6">
                    <!-- Plataformas -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-slate-700 mb-4 text-xs uppercase tracking-widest border-b pb-2 flex justify-between">
                            <span>1. Plataformas</span> <span id="prod-mode-badge" class="text-[9px] bg-slate-100 px-2 py-0.5 rounded text-slate-400 font-bold">CREAR</span>
                        </h3>
                        <div class="bg-indigo-50 p-4 rounded-xl mb-4 border border-indigo-100 flex flex-col md:flex-row gap-2">
                            <input type="hidden" id="edit-prod-id">
                            <input type="text" id="new-prod-name" placeholder="Nombre" class="flex-grow border rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                            <div class="flex gap-2">
                                <input type="number" id="new-prod-cost" placeholder="Costo" class="w-20 border rounded-lg px-2 py-2 text-sm text-center outline-none focus:ring-2 focus:ring-indigo-500">
                                <input type="number" id="new-prod-price" placeholder="Venta" class="w-20 border rounded-lg px-2 py-2 text-sm text-center outline-none focus:ring-2 focus:ring-indigo-500">
                                <button id="btn-prod-action" class="bg-indigo-600 text-white px-4 rounded-lg font-bold text-sm shadow-md transition">Agregar</button>
                                <button id="btn-prod-cancel" onclick="cancelEdit('prod')" class="bg-slate-300 text-slate-600 px-3 rounded-lg font-bold text-sm hidden hover:bg-slate-400"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>
                        <div class="overflow-y-auto max-h-60 border rounded-xl"><table class="w-full text-sm text-left"><tbody id="config-prod-list" class="divide-y divide-gray-100 text-slate-700"></tbody></table></div>
                    </div>
                    <!-- Vendedores -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-slate-700 mb-4 text-xs uppercase tracking-widest border-b pb-2 flex justify-between">
                            <span>2. Vendedores</span> <span id="seller-mode-badge" class="text-[9px] bg-slate-100 px-2 py-0.5 rounded text-slate-400 font-bold">CREAR</span>
                        </h3>
                        <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-100 flex flex-col md:flex-row gap-2">
                            <input type="hidden" id="edit-seller-id">
                            <input type="text" id="new-seller-name" placeholder="Nombre" class="flex-grow border rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-400">
                            <div class="flex gap-2">
                                <input type="tel" id="new-seller-phone" placeholder="Celular" class="w-32 border rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-slate-400">
                                <button id="btn-seller-action" class="bg-slate-800 text-white px-4 rounded-lg font-bold text-sm shadow-md transition">Crear</button>
                                <button id="btn-seller-cancel" onclick="cancelEdit('seller')" class="bg-slate-300 text-slate-600 px-3 rounded-lg font-bold text-sm hidden hover:bg-slate-400"><i class="fa-solid fa-xmark"></i></button>
                            </div>
                        </div>
                        <div class="overflow-y-auto max-h-60"><ul id="config-seller-list" class="space-y-2"></ul></div>
                    </div>
                    <!-- DistribuciÃ³n -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-200"><h3 class="font-bold text-slate-700 mb-4 text-xs uppercase tracking-widest border-b pb-2">3. DistribuciÃ³n</h3><div class="space-y-4"><div><label class="flex justify-between text-xs font-bold text-slate-500 mb-1">Admin: <span id="display-admin-pct" class="text-indigo-600">60%</span></label><input type="range" id="range-admin" min="0" max="100" value="60" oninput="updateConfigRange('admin')" class="w-full h-1.5 bg-slate-200 rounded-lg accent-indigo-600"></div><div><label class="flex justify-between text-xs font-bold text-slate-500 mb-1">Vendedor: <span id="display-seller-pct" class="text-emerald-600">40%</span></label><input type="range" id="range-seller" min="0" max="100" value="40" oninput="updateConfigRange('seller')" class="w-full h-1.5 bg-slate-200 rounded-lg accent-emerald-500"></div><button id="btn-save-config" class="w-full py-2 bg-slate-900 text-white rounded-lg text-xs font-bold uppercase tracking-widest hover:bg-black transition shadow-lg">Guardar Cambios</button></div></div>
                </div>
            </div>

            <!-- 4. DASHBOARD -->
            <div id="tab-dashboard" class="app-tab hidden w-full">
                <h2 class="text-xl font-black text-slate-800 mb-6">REPORTES</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase">Ventas</p><p id="dash-total" class="text-xl font-black text-slate-800">0.00</p></div>
                    <div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-indigo-500 font-bold uppercase">Utilidad</p><p id="dash-admin" class="text-xl font-black text-indigo-600">0.00</p></div>
                    <div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-emerald-500 font-bold uppercase">Comisiones</p><p id="dash-seller" class="text-xl font-black text-emerald-600">0.00</p></div>
                    <div class="bg-white p-4 rounded-2xl border shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase">Ops</p><p id="dash-count" class="text-xl font-black text-slate-800">0</p></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border shadow-sm h-64 md:h-96 w-full"><canvas id="chartSellers"></canvas></div>
            </div>
        </div>
    </main>

    <div id="toast" class="fixed bottom-8 right-1/2 translate-x-1/2 md:translate-x-0 md:right-8 bg-slate-900 text-white px-5 py-3 rounded-xl shadow-2xl translate-y-40 transition-transform duration-500 z-50 flex items-center gap-3 whitespace-nowrap"><div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center text-white"><i class="fa-solid fa-check text-xs"></i></div><p class="text-xs md:text-sm font-bold">Â¡Hecho!</p></div>

    <!-- SCRIPT DE INTERFAZ (MENÃš) - SIEMPRE FUNCIONA -->
    <script>
        // Funciones UI Globales (Fuera de MÃ³dulo para evitar bloqueos)
        function toggleMobileMenu() {
            const s=document.getElementById('sidebar'), o=document.getElementById('mobile-overlay');
            if(s.classList.contains('-translate-x-full')){s.classList.remove('-translate-x-full');o.classList.remove('hidden');}else{s.classList.add('-translate-x-full');o.classList.add('hidden');}
        }
        function closeMobileMenu() { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('mobile-overlay').classList.add('hidden'); }
        
        function switchAppTab(t) { 
            document.querySelectorAll('.app-tab').forEach(e=>e.classList.add('hidden')); 
            document.getElementById('tab-'+t).classList.remove('hidden'); 
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active','bg-indigo-700','text-white')); 
            document.getElementById('nav-'+t).classList.add('active','bg-indigo-700','text-white'); 
            if(t==='history' && window.renderHistoryTable) window.renderHistoryTable(); 
            if(t==='dashboard' && window.updateDashboard) window.updateDashboard();
            if(window.innerWidth<768) closeMobileMenu(); 
        }
        
        function showToast(m) { const t=document.getElementById('toast');t.querySelector('p').innerText=m;t.classList.remove('translate-y-40');setTimeout(()=>t.classList.add('translate-y-40'),3000); }
        
        // Reloj
        setInterval(()=> { const d=new Date(); document.getElementById('clock').innerText=d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }, 1000);
    </script>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, updateDoc, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ==========================================
        //  TU LLAVE (YA INTEGRADA)
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyDrMs4FRGpGeVGw1gWLltOWZlQVeYFpQf8",
          authDomain: "kgb-system.firebaseapp.com",
          projectId: "kgb-system",
          storageBucket: "kgb-system.firebasestorage.app",
          messagingSenderId: "850376757764",
          appId: "1:850376757764:web:80f62ecbe11b4f25405b51",
          measurementId: "G-Y4WG6QN4KQ"
        };

        // --- INICIALIZACIÃ“N ---
        let db = null;
        let STATE = JSON.parse(localStorage.getItem('kgb_local_db_v8')) || { sellers: [], products: [], sales: [], config: { adminPct: 0.60, sellerPct: 0.40 } };

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            setupCloudListeners();
            updateStatus(true);
            document.getElementById('loader').classList.add('hidden'); // Ocultar loader al conectar
        } catch (e) {
            console.error("Modo Offline (Error Init):", e);
            updateStatus(false);
            document.getElementById('loader').classList.add('hidden'); // Ocultar loader aunque falle
        }

        function updateStatus(isCloud) {
            const dot = document.getElementById('status-dot');
            const txt = document.getElementById('status-text'); // Fixed ID usage in HTML
            // Note: HTML uses 'status-text' but sidebar HTML actually has it? Wait, let me check the sidebar HTML above.
            // Sidebar HTML has: <span class="font-bold text-slate-300">Conectado</span> inside a div, but no ID on span in provided V6.1.
            // Correcting selector strategy:
            // Actually, in this v7.0 HTML I added IDs connection-dot and connection-text in sidebar.
            // But let's verify if I named them correctly in HTML block above.
            // Sidebar block above: id="status-dot", span has no ID but class text-slate-300. 
            // Let's target parent div and update content safely.
            const statusContainer = document.querySelector('.bg-black\\/20 .flex'); // Target footer status container
            if(statusContainer) {
                if (isCloud) {
                    statusContainer.innerHTML = `<div class="w-2.5 h-2.5 rounded-full bg-green-500 animate-pulse"></div><span class="font-bold text-green-400">Nube Activa</span>`;
                } else {
                    statusContainer.innerHTML = `<div class="w-2.5 h-2.5 rounded-full bg-orange-500"></div><span class="font-bold text-orange-400">Modo Local</span>`;
                }
            }
            refreshUI();
        }

        // --- SISTEMA DUAL: NUBE O LOCAL ---
        async function saveData(col, data) {
            // Guardar Local Primero
            if(col==='kgb_sales') STATE.sales.unshift({...data, id: 'temp_'+Date.now()}); 
            else if(col==='kgb_sellers') STATE.sellers.push({...data, id: 'temp_'+Date.now()});
            else if(col==='kgb_products') STATE.products.push({...data, id: 'temp_'+Date.now()});
            else if(col==='kgb_config') STATE.config = data;
            
            saveLocal();
            refreshUI();

            // Cloud Sync
            if(db) {
                try {
                    if(col==='kgb_config') await setDoc(doc(db, "kgb_config", "main"), data);
                    else await addDoc(collection(db, col), data);
                    showToast("Guardado en Nube");
                } catch(e) { showToast("Guardado Localmente"); }
            } else {
                showToast("Guardado Local");
            }
        }
        
        async function updateData(col, id, data) {
            // Update Local
            if (col==='kgb_sellers') { const i=STATE.sellers.findIndex(x=>x.id==id); if(i>-1) Object.assign(STATE.sellers[i], data); }
            if (col==='kgb_products') { const i=STATE.products.findIndex(x=>x.id==id); if(i>-1) Object.assign(STATE.products[i], data); }
            if (col==='kgb_sales') { const i=STATE.sales.findIndex(x=>x.id==id); if(i>-1) Object.assign(STATE.sales[i], data); }
            saveLocal();
            refreshUI();

            // Update Cloud
            if(db && !String(id).startsWith('temp_')) {
                try { await updateDoc(doc(db, col, id), data); } catch(e){}
            }
        }

        function saveLocal() { localStorage.setItem('kgb_local_db_v8', JSON.stringify(STATE)); }

        function setupCloudListeners() {
            onSnapshot(collection(db, "kgb_sellers"), s => { STATE.sellers=s.docs.map(d=>({id:d.id,...d.data()})).filter(x=>x.active); saveLocal(); refreshUI(); });
            onSnapshot(collection(db, "kgb_products"), s => { STATE.products=s.docs.map(d=>({id:d.id,...d.data()})).filter(x=>x.active); saveLocal(); refreshUI(); });
            onSnapshot(query(collection(db, "kgb_sales"), orderBy("date", "desc")), s => { STATE.sales=s.docs.map(d=>({id:d.id,...d.data()})); saveLocal(); if(window.renderHistoryTable) window.renderHistoryTable(); });
            onSnapshot(doc(db, "kgb_config", "main"), s => { if(s.exists()) { STATE.config=s.data(); saveLocal(); updateConfigInputs(); } });
        }

        // --- LOGIC: POS ---
        window.updatePosCalc = () => {
            const idx = document.getElementById('pos-product').value;
            if(idx === "" || !STATE.products[idx]) { document.getElementById('pos-cost').value='0.00'; document.getElementById('pos-price').value='0.00'; document.getElementById('pos-profit').innerText='0.00'; return; }
            const p = STATE.products[idx]; document.getElementById('pos-cost').value = p.cost.toFixed(2);
            let curr = parseFloat(document.getElementById('pos-price').value); if(curr===0 || isNaN(curr)) { curr = p.price; document.getElementById('pos-price').value=curr.toFixed(2); }
            reCalcProfitOnly();
        }
        window.reCalcProfitOnly = () => { const c=parseFloat(document.getElementById('pos-cost').value)||0; const p=parseFloat(document.getElementById('pos-price').value)||0; document.getElementById('pos-profit').innerText=(p-c).toFixed(2); };

        document.getElementById('btn-submit').onclick = async () => {
            const idx = document.getElementById('pos-product').value; const sId = document.getElementById('pos-seller').value; if(idx==="" || sId==="") return alert("Faltan datos");
            const p = STATE.products[idx]; 
            const s = STATE.sellers.find(x => x.id == sId) || STATE.sellers[sId];

            const price = parseFloat(document.getElementById('pos-price').value); const prof = price - p.cost;
            const sale = {
                date: new Date().toISOString(), seller: s.name, sellerPhone: s.phone, product: p.name, 
                cost: p.cost, price: price, profit: prof, admin: prof*STATE.config.adminPct, 
                comm: prof*STATE.config.sellerPct, client: document.getElementById('pos-client').value, 
                phone: document.getElementById('pos-phone').value, status: 'active'
            };
            await saveData('kgb_sales', sale);
            document.getElementById('pos-client').value=''; document.getElementById('pos-phone').value='';
        };

        // --- ACTIONS ---
        document.getElementById('btn-seller-action').onclick = async () => {
            const id = document.getElementById('edit-seller-id').value; const name = document.getElementById('new-seller-name').value; const phone = document.getElementById('new-seller-phone').value; if(!name) return;
            if(id) { await updateData('kgb_sellers', id, {name, phone}); showToast("Actualizado"); cancelEdit('seller'); } 
            else { await saveData('kgb_sellers', { name, phone, active: true }); showToast("Creado"); }
            document.getElementById('new-seller-name').value=''; document.getElementById('new-seller-phone').value='';
        };
        document.getElementById('btn-prod-action').onclick = async () => {
            const id = document.getElementById('edit-prod-id').value; const name = document.getElementById('new-prod-name').value; const cost = parseFloat(document.getElementById('new-prod-cost').value); const price = parseFloat(document.getElementById('new-prod-price').value); if(!name) return;
            if(id) { await updateData('kgb_products', id, {name, cost, price}); showToast("Actualizado"); cancelEdit('prod'); } 
            else { await saveData('kgb_products', { name, cost, price, active: true }); showToast("Creado"); }
            document.getElementById('new-prod-name').value='';
        };
        document.getElementById('btn-save-config').onclick = async () => { await saveData('kgb_config', { adminPct: document.getElementById('range-admin').value / 100, sellerPct: document.getElementById('range-seller').value / 100 }); };

        window.deleteItem = async (c, id) => { if(confirm("Â¿Eliminar?")) await updateData(c, id, { active: false }); };
        window.refundSale = async (id) => { if(confirm("Â¿Anular?")) await updateData('kgb_sales', id, { status: 'REFUNDED' }); };

        window.prepareEdit = (t, id) => {
            if(t==='seller') { const s = STATE.sellers.find(x=>x.id===id); document.getElementById('edit-seller-id').value=id; document.getElementById('new-seller-name').value=s.name; document.getElementById('new-seller-phone').value=s.phone; document.getElementById('seller-mode-badge').innerText="EDITANDO"; document.getElementById('btn-seller-action').innerText="Actualizar"; document.getElementById('btn-seller-action').classList.replace('bg-slate-800', 'bg-blue-600'); document.getElementById('btn-seller-cancel').classList.remove('hidden'); }
            else { const p = STATE.products.find(x=>x.id===id); document.getElementById('edit-prod-id').value=id; document.getElementById('new-prod-name').value=p.name; document.getElementById('new-prod-cost').value=p.cost; document.getElementById('new-prod-price').value=p.price; document.getElementById('prod-mode-badge').innerText="EDITANDO"; document.getElementById('btn-prod-action').innerText="Actualizar"; document.getElementById('btn-prod-action').classList.replace('bg-indigo-600', 'bg-blue-600'); document.getElementById('btn-prod-cancel').classList.remove('hidden'); }
        };
        window.cancelEdit = (t) => { 
            document.getElementById(t==='seller'?'edit-seller-id':'edit-prod-id').value=''; document.getElementById(t==='seller'?'new-seller-name':'new-prod-name').value=''; 
            document.getElementById(`${t}-mode-badge`).innerText="CREAR"; document.getElementById(`btn-${t}-action`).innerText=t==='prod'?'Agregar':'Crear'; document.getElementById(`btn-${t}-cancel`).classList.add('hidden');
            if(t==='seller') document.getElementById('btn-seller-action').classList.replace('bg-blue-600', 'bg-slate-800');
            else document.getElementById('btn-prod-action').classList.replace('bg-blue-600', 'bg-indigo-600');
        };

        // Renders
        function renderPosSelects() { const sel = document.getElementById('pos-seller'); const pro = document.getElementById('pos-product'); sel.innerHTML = STATE.sellers.map((s,i) => `<option value="${s.id}">${s.name}</option>`).join(''); pro.innerHTML = '<option value="">Seleccione...</option>' + STATE.products.map((p, i) => `<option value="${i}">${p.name}</option>`).join(''); }
        function renderSellerList() { document.getElementById('config-seller-list').innerHTML = STATE.sellers.map(s => `<li class="flex justify-between items-center p-3 bg-slate-50 border rounded-lg text-sm"><div><span class="font-bold block">${s.name}</span><span class="text-xs text-slate-400">${s.phone}</span></div><div class="flex gap-2"><button onclick="prepareEdit('seller','${s.id}')" class="text-blue-500 border p-1 rounded hover:bg-blue-50"><i class="fa-solid fa-pen"></i></button><button onclick="deleteItem('kgb_sellers','${s.id}')" class="text-red-500 border p-1 rounded hover:bg-red-50"><i class="fa-solid fa-trash"></i></button></div></li>`).join(''); }
        function renderProductList() { document.getElementById('config-prod-list').innerHTML = STATE.products.map(p => `<tr class="border-b"><td class="p-3 font-bold">${p.name}</td><td class="p-3 text-center">${p.cost}</td><td class="p-3 text-center font-bold text-indigo-600">${p.price}</td><td class="p-3 text-right"><button onclick="prepareEdit('prod','${p.id}')" class="text-blue-500 border p-1 rounded hover:bg-blue-50 mr-2"><i class="fa-solid fa-pen"></i></button><button onclick="deleteItem('kgb_products','${p.id}')" class="text-red-500 border p-1 rounded hover:bg-red-50"><i class="fa-solid fa-trash"></i></button></td></tr>`).join(''); }
        function updateConfigInputs() { document.getElementById('range-admin').value = STATE.config.adminPct * 100; document.getElementById('range-seller').value = STATE.config.sellerPct * 100; }
        
        window.renderHistoryTable = () => {
            const start = document.getElementById('filter-start').value; const end = document.getElementById('filter-end').value; const sId = document.getElementById('filter-seller').value;
            let d = STATE.sales; if(start) d = d.filter(x => x.date.split('T')[0] >= start); if(end) d = d.filter(x => x.date.split('T')[0] <= end);
            if(sId) { const sName = STATE.sellers.find(x => x.id === sId)?.name; if(sName) d = d.filter(x => x.seller === sName); }
            
            let tc=0, ts=0, rc=0; d.forEach(x => { if(x.status !== 'REFUNDED') { tc += x.comm; ts += x.price; } else { rc++; } });
            document.getElementById('liq-comm').innerText = 'S/ ' + tc.toFixed(2); document.getElementById('liq-total').innerText = 'S/ ' + ts.toFixed(2); document.getElementById('liq-count').innerText = d.length - rc; document.getElementById('liq-refunds').innerText = rc;

            document.getElementById('history-table-body').innerHTML = d.map(s => {
                const isR = s.status === 'REFUNDED';
                const vText = `ðŸŽ« KGB REGISTRO\n----------------\nðŸ“… ${new Date(s.date).toLocaleDateString()}\nðŸ‘¤ ${s.seller}\nðŸ“º ${s.product}\nðŸ’° COMISIÃ“N: S/ ${Number(s.comm).toFixed(2)}\nâœ… Verificado`;
                const safeV=JSON.stringify(vText).replace(/"/g,'&quot;'); const cleanP = s.sellerPhone ? String(s.sellerPhone).replace(/\s/g, '') : '';
                return `<tr class="border-b hover:bg-slate-50 ${isR?'refunded-row':''} transition"><td class="px-4 py-3"><div class="font-black text-xs uppercase text-indigo-900">${s.product}</div><div class="text-[10px] text-slate-500">${new Date(s.date).toLocaleDateString()} - ${s.seller}</div></td><td class="px-4 py-3"><div class="font-bold text-xs text-slate-700">${s.client||'-'}</div></td><td class="px-4 py-3 text-right font-black text-sm text-emerald-600">${isR?'0.00':'S/ '+Number(s.comm).toFixed(2)}</td><td class="px-4 py-3 text-center"><div class="flex justify-center gap-2">${isR?'<span class="text-[9px] font-bold text-red-600 bg-red-100 px-2 py-1 rounded">DEV</span>':`<button onclick="refundSale('${s.id}')" class="text-red-400 border rounded w-8 h-8 hover:bg-red-50"><i class="fa-solid fa-rotate-left"></i></button><button onclick='copyV("${safeV}")' class="text-blue-500 border rounded w-8 h-8 hover:bg-blue-50"><i class="fa-regular fa-copy"></i></button><button onclick="window.open('https://wa.me/${cleanP}?text=${encodeURIComponent(vText)}','_blank')" class="text-green-500 border rounded w-8 h-8 hover:bg-green-50"><i class="fa-brands fa-whatsapp"></i></button>`}</div></td></tr>`;
            }).join('');
        };
        window.copyV = (t) => { const ta=document.createElement("textarea"); ta.value=t; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showToast("Copiado"); };
        function renderFilterSeller() { const sel = document.getElementById('filter-seller'); sel.innerHTML = '<option value="">Todos</option>' + STATE.sellers.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); }
        
        window.updateDashboard = () => {
            let t=0,a=0,s=0,c=0; STATE.sales.forEach(x=>{if(x.status!=='REFUNDED'){t+=Number(x.price);a+=Number(x.admin);s+=Number(x.comm);c++;}});
            document.getElementById('dash-total').innerText=t.toFixed(2);document.getElementById('dash-admin').innerText=a.toFixed(2);document.getElementById('dash-seller').innerText=s.toFixed(2);document.getElementById('dash-count').innerText=c;
        };
        window.exportToExcel = () => { const ws=XLSX.utils.json_to_sheet(STATE.sales); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Ventas"); XLSX.writeFile(wb,"Reporte_Cloud.xlsx"); };

        document.getElementById('range-admin').oninput = function() { const v = parseInt(this.value); document.getElementById('range-seller').value = 100 - v; };

        // INIT LOAD
        refreshUI();
    </script>
</body>
</html>
